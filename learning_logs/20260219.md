----- PART1. -----

1.
CREATE DATABASE sql_finals;

2.
USE sql_finals;

3.
CREATE TABLE users(
id INT PRIMARY KEY AUTO_INCREMENT,
created_at VARCHAR(100),
username VARCHAR(100) NOT NULL,
phone VARCHAR(100),
country VARCHAR(50));

4.
ALTER TABLE `users`
ADD COLUMN `is_marketing_agree` INT NULL AFTER `country`;

5.
ALTER TABLE `users`
CHANGE COLUMN `phone` `user_phone` VARCHAR(100);

6.
ALTER TABLE `users`
DROP COLUMN `created_at`;

7.
CREATE TABLE products(
id INT PRIMARY KEY AUTO_INCREMENT,
`name` VARCHAR(255) NOT NULL,
price DECIMAL(10,2) NOT NULL,
discount_price DECIMAL(10,2) NOT NULL);

8.
ALTER TABLE `products` CHANGE COLUMN `name` `name` VARCHAR(500);

9.
CREATE TABLE staff(
id INT PRIMARY KEY AUTO_INCREMENT,
user_id INT NOT NULL,
last_name VARCHAR(50) NOT NULL,
first_name VARCHAR(50) NOT NULL,
birth_date DATE);

10.
CREATE TABLE `orders` (
	`id` INT(11) NOT NULL AUTO_INCREMENT,
	`user_id` INT(11) NULL DEFAULT '0',
	`staff_id` INT(11) NULL DEFAULT '0',
	`order_date` DATE NULL DEFAULT '0000-00-00',
	PRIMARY KEY (`id`) USING BTREE,
	INDEX `FK1_user_id` (`user_id`) USING BTREE,
	INDEX `FK2_staff_id` (`staff_id`) USING BTREE,
	CONSTRAINT `FK1_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON UPDATE RESTRICT ON DELETE RESTRICT,
	CONSTRAINT `FK2_staff_id` FOREIGN KEY (`staff_id`) REFERENCES `staff` (`id`) ON UPDATE RESTRICT ON DELETE RESTRICT
)
COLLATE='utf8mb4_uca1400_ai_ci'
ENGINE=InnoDB
;

11.
CREATE TABLE `orderdetails` (
	`id` INT(11) NOT NULL AUTO_INCREMENT,
	`order_id` INT(11) NULL DEFAULT '0',
	`product_id` INT(11) NULL DEFAULT '0',
	`quantity` INT(11) NOT NULL DEFAULT '0',
	PRIMARY KEY (`id`) USING BTREE,
	INDEX `FK1_order_id` (`order_id`) USING BTREE,
	INDEX `FK2_product_id` (`product_id`) USING BTREE,
	CONSTRAINT `FK1_order_id` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON UPDATE RESTRICT ON DELETE RESTRICT,
	CONSTRAINT `FK2_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON UPDATE RESTRICT ON DELETE RESTRICT
)
COLLATE='utf8mb4_uca1400_ai_ci'
ENGINE=InnoDB
;

12.
ALTER TABLE `users` DROP COLUMN `is_marketing_agree`;

13.
ALTER TABLE `orderdetails` CHANGE COLUMN `quantity` `amount` INT(11) NOT NULL DEFAULT '0' AFTER `product_id`;

14.
DROP TABLE orderdetails;

15.
DROP DATABASE sql_finals;

----- PART 2 -----

1.
ALTER TABLE users CHANGE COLUMN created_at city VARCHAR(100);
INSERT INTO users (username, phone, city, country) VALUES
('joejoe@joecompany.com', '010-1234-5678', 'Seoul', 'Korea'),
('phk4938@never.com', '010-9876-5432', 'Buenos Aires', 'Argentina');

2.
INSERT INTO users (username, phone, city, country) VALUES
('inr01@never.com', '010-1111-2222', 'New York', 'USA'),
('fuxp76@never.com', '010-3333-4444', 'Seoul', 'Korea');

3.
INSERT INTO products (`name`, price, discount_price) VALUES
('Terrarossa Coffee Back', 18.00, 15.00);

4.
INSERT INTO products (`name`, price, discount_price) VALUES
('Mini Cheese Ball', 19.00, 19.00),
('Stabucks Drip Coffee', 22.00, 22.00);

5.
INSERT INTO staff (user_id, last_name, first_name, birth_date) VALUES
(2, 'Carter', 'Joe', '1990-10-20'),
(10, 'Jang', 'Ken', '1991-02-19');

6. 
INSERT INTO orders (user_id, staff_id, order_date) VALUES
(2, 1, '2025-09-18');

7. 
INSERT INTO orderdetails (order_id, product_id, quantity) VALUES
(1, 1, 2),
(1, 2, 3);

8.
UPDATE users SET phone = '010-5555-6666'
WHERE username = 'inr01@never.com';

9.
UPDATE products SET price = 20.00
WHERE `name` = 'Mini Cheese ball';

10.
UPDATE staff SET first_name = 'Minjun'
WHERE user_id = 10;

11.
DELETE FROM users WHERE username = 'phk4938@never.com';

12.
DELETE FROM products WHERE id = 3;

13.
DELETE FROM orderdetails WHERE order_id = 1;

14.
DELETE FROM users;

15.
DELETE FROM orders WHERE order_date = '2025-09-18';

----- PART 3 -----

1. 
SELECT id, username, phone FROM users;

2.
SELECT COUNT(order_date) AS '2015년 주문된 수' FROM orders
WHERE order_date BETWEEN '2015-01-01' AND '2015-12-31';

3.
SELECT `name` FROM products
WHERE price = (SELECT MAX(price) FROM products);

4.
SELECT id, username FROM users
WHERE country = 'Korea';

5.
SELECT last_name, first_name FROM staff
WHERE birth_date < '1960-01-01';

6.
SELECT id, order_date FROM orders
WHERE user_id = 20;

7. 
SELECT SUM(quantity) FROM orderdetails
WHERE product_id = 17;

8.
SELECT round(AVG(price),2) FROM products;

9.
SELECT country, COUNT(id) AS '국가별회원수' FROM users
GROUP BY country
HAVING COUNT(id) > 5;

10.
SELECT staff_id, count(id) AS '주문건수' FROM orders
GROUP BY staff_id
ORDER BY 주문건수 desc;

11.
SELECT u.username, COUNT(u.id) AS 주문건수  FROM users u
JOIN orders o ON u.id = o.user_id
GROUP BY o.user_id
HAVING 주문건수 > 2;

12.
SELECT u.username, s.last_name, s.first_name FROM users u
JOIN staff s ON u.id = s.user_id

13.
SELECT o.id, SUM(od.quantity) AS 총_주문_수량 from orders o
JOIN orderdetails od ON o.id = od.order_id
GROUP BY o.id
HAVING 총_주문_수량 > 100;

14.
SELECT COUNT(u.id) AS 주문한_총_건수  FROM users u
JOIN orders o ON u.id = o.user_id
WHERE country = 'USA';

15.
SELECT COUNT(id) AS 주문건수  FROM orders
WHERE order_date BETWEEN '2015-12-01' AND '2015-12-31' AND staff_id = 3;

16.
SELECT `name`, price FROM products
WHERE price > (select AVG(price) FROM products);

17.
SELECT city, COUNT(id) FROM users
GROUP BY city
HAVING city = 'Seoul';

18.
SELECT o.id, ROUND((p.price * od.quantity)) AS 총주문금액 FROM orders o
JOIN orderdetails od ON o.id = od.order_id
JOIN products p ON od.product_id = p.id
GROUP BY o.id
HAVING 총주문금액 > 2000;

19.
SELECT `name`, price FROM products
WHERE `name` LIKE '%Coffee%'; 

20.
SELECT last_name, first_name FROM staff
WHERE birth_date < '1960-01-01'
UNION
SELECT last_name, first_name FROM staff
WHERE birth_date > '1990-01-01';